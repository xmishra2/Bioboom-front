<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BioBoom GM</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; max-width: 800px; margin: auto; }
    input, textarea, button { display: block; width: 100%; margin: 10px 0; padding: 10px; }
    h2 { margin-top: 2rem; }
    pre { background: #f4f4f4; padding: 1rem; overflow-x: auto; }
  </style>
</head>
<body>
  <script>
    const role = sessionStorage.getItem('role');
    const pin = sessionStorage.getItem('pin');
    if (role !== 'gm' || !pin) {
      alert("Access denied. Please login as Game Master.");
      window.location.href = "login.html";
    }
  </script>

  <h2>🧠 Game Master Dashboard</h2>

  <button onclick="generatePin()">🔁 Generate New Player PIN</button>
  <p id="pinDisplay"></p>

  <h2>🎲 Set Scenario</h2>
  <input id="scenario" placeholder="e.g., Recession, Boom..." />
  <textarea id="policyNote" placeholder="Add any policy notes..."></textarea>
  <button onclick="setScenario()">🚀 Launch Scenario</button>

  <h2>📊 Submissions</h2>
  <button onclick="loadSubmissions()">🔄 Refresh Submissions</button>
  <pre id="submissionsBox">Waiting for player inputs...</pre>

  <h2>📤 Export & Reset</h2>
  <button onclick="exportData()">📁 Export Submissions (CSV)</button>
  <button onclick="resetGame()">♻️ Reset Game</button>

  <script>
    const API = 'https://bioboomserver.onrender.com';

    function generatePin() {
      fetch(`${API}/generate-pin`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
          document.getElementById('pinDisplay').innerText =
            `✅ New PIN: ${data.pin} (valid till ${new Date(data.expires).toLocaleString()})`;
        });
    }

    function setScenario() {
      const scenario = document.getElementById('scenario').value;
      const policyNote = document.getElementById('policyNote').value;
      fetch(`${API}/scenario`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ scenario, policyNote })
      }).then(() => alert("Scenario set!"));
    }

    function loadSubmissions() {
      fetch(`${API}/submissions`)
        .then(res => res.json())
        .then(data => {
          document.getElementById('submissionsBox').innerText =
            JSON.stringify(data, null, 2);
        });
    }

    function exportData() {
      fetch(`${API}/submissions`)
        .then(res => res.json())
        .then(data => {
          let csv = 'Player,Sector,Strategy,TRL,MRL,Units,Target,ESG,Feedback\n';
          for (const player in data) {
            data[player].forEach(sub => {
              csv += `${player},${sub.sector},${sub.strategy},${sub.trl},${sub.mrl},${sub.units},${sub.target},${sub.esg},"${sub.feedback}"\n`;
            });
          }
          const blob = new Blob([csv], { type: 'text/csv' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `BioBoom_Submissions_${new Date().toISOString().slice(0,10)}.csv`;
          a.click();
          URL.revokeObjectURL(url);
        });
    }

    function resetGame() {
      if (confirm("⚠️ Are you sure you want to reset the game? This will erase all submissions.")) {
        fetch(`${API}/scenario`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ scenario: null, policyNote: "" })
        }).then(() => {
          alert("✅ Game reset. All submissions cleared.");
          document.getElementById('submissionsBox').innerText = "Waiting for player inputs...";
        });
      }
    }
  </script>
</body>
</html>
